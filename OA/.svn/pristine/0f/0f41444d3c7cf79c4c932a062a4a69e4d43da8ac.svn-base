package cn.tempus.scheduled;

import cn.tempus.commons.GlobalCls;
import cn.tempus.dao.EasyDao;
import cn.tempus.email.Email;

import org.apache.commons.mail.HtmlEmail;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import java.util.HashMap;
import java.util.Iterator;

@Component
public class SendEmail {
	
	protected static Logger logger = LoggerFactory.getLogger(SendEmail.class);

    @Autowired
    EasyDao basicService;

    @Autowired
    public Email email;

    /**
     * 每天00:00:00 (午夜12点)定时发送
     */
    @Scheduled(cron = "0 0 0 * * ?")
    public void sendEmail(){
        String sql = "select b.user_id fid,b.user_name fname,b.email_address femail,count(*) fcount from(select distinct * from (select a.id_ taskid,b.user_id_ userid from act_ru_task a inner join act_ru_identitylink b on b.task_id_=a.id_ union select id_ taskid,assignee_ userid from act_ru_task where assignee_ is not null)) a inner join tb_user b on b.user_id=a.userid group by b.user_id,b.user_name,b.email_address";
        Iterator<HashMap<String, Object>> list = basicService.SelectListBySql(sql).iterator();

        try {
            while (list.hasNext()){
                HashMap<String,Object> userinfo = list.next();
                if (userinfo.get("FEMAIL") != null) {
                	HtmlEmail htmlemail = email.getHtmlEmail();
                    htmlemail.addTo(userinfo.get("FEMAIL").toString(),userinfo.get("FEMAIL").toString());
                    htmlemail.setSubject("待办任务提醒 "+userinfo.get("FCOUNT")+"个");
//                  msg.setBody(MessageBody.getMessageBodyFromText("<html><div>Dear "+userinfo.get("FNAME")+",</div><div style='text-indent:2em;'>腾邦控股业务申请与审批系统中有"+userinfo.get("FCOUNT")+"个申请正在等待您审批，为避免业务延误，请您及时登录系统进行审核。谢谢。</div><a href='https://"+ GlobalCls.GP.getProperty("server.ip")+":"+GlobalCls.GP.getProperty("server.port")+"/OA/MyWorkFlow/MyToBeDo'>办理任务</a></html>"));
                    htmlemail.setHtmlMsg("<html><div>Dear "+userinfo.get("FNAME")+",</div><div style='text-indent:2em;'>腾邦控股业务申请与审批系统中有"+userinfo.get("FCOUNT")+"个申请正在等待您审批，为避免业务延误，请您及时登录系统进行审核。谢谢。</div><a href='https://"+ GlobalCls.GP.getProperty("server.ip")+":"+GlobalCls.GP.getProperty("server.port")+"/OA/MyWorkFlow/MyToBeDo'>办理任务</a></html>");
                    htmlemail.send();
                    logger.info("email address:"+htmlemail.getToAddresses());
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }

    }
}
